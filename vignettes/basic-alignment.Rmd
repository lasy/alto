---
title: "Basic Alignment"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{basic-alignment}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

This is mainly a way to test our code without having a full `testthat` workflow.

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
#devtools::document(); devtools::install(quick = TRUE)
library(alto)
library(stringr)
set.seed(123)
```

This step will eventually be replaced by a `run_lda_models` call.

```{r}
simulate_lda <- function(betas, gammas, n0=NULL) {
  n <- nrow(gammas)
  if (is.null(n0)) {
    n0 <- rpois(n, 1000)
  }

  x <- matrix(nrow = n, ncol = ncol(betas))
  for (i in seq_len(n)) {
    x[i, ] <- rmultinom(1, n0[i], t(betas) %*% gammas[i, ])
  }
  rownames(x) <- seq_len(n)
  colnames(x) <- seq_len(ncol(betas))
  x
}

library("MCMCpack")
betas <- rdirichlet(10, rep(.1, 50))
gammas <- rdirichlet(100, rep(.1, 10))
data <- simulate_lda(betas, gammas)
```


```{r}
lda_varying_params_lists <- lapply(1:10, function(z) list(k = z))
names(lda_varying_params_lists) <- str_c("K", 1:10)
lda_models =
   run_lda_models(
      data = data,
      lda_varying_params_lists = lda_varying_params_lists
      )
```

```{r}
result <- align_topics(lda_models, "consecutive")
result
plot(result)
plot_beta(result)
```


```{r}
weights <- result@weights %>%
  dplyr::filter(m == "K5") %>%
  dplyr::select(k_LDA, k_LDA_next, norm_weight) %>%
  dplyr::group_by(k_LDA) %>%
  dplyr::slice_max(norm_weight, n = 4)

P <- weights %>%
  dplyr::mutate(ix = dplyr::row_number()) %>%
  dplyr::select(-norm_weight) %>%
  tidyr::pivot_wider(names_from = ix, values_from = k_LDA_next) %>%
  dplyr::ungroup() %>%
  dplyr::select(-k_LDA) %>%
  t()
```
```{r}

```

```{r}
result <- align_topics(lda_models, "all")
result
```

```{r}
result <- align_topics(lda_models, "consecutive", method = "transport")
result
```

```{r}
plot(result)
plot_beta(result)
```

